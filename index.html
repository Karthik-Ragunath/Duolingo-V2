<!DOCTYPE html>
<html>
<head>
    <title>Video Call with Live Utterances</title>
    <style>
        body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
        #left-pane { flex: 1; padding: 10px; border-right: 1px solid #ccc; display: flex; flex-direction: column; overflow-y: auto; }
        #right-pane { flex: 1; padding: 10px; display: flex; flex-direction: column; overflow-y: auto; }
        #utterances-content { flex-grow: 1; overflow-y: auto; border: 1px solid #eee; padding: 5px; }
        #utterances-content p { margin: 0 0 5px 0; padding: 3px; border-bottom: 1px dotted #f0f0f0; }
        #utterances-content p:last-child { border-bottom: none; }
        iframe { width: 100%; border: none; }
    </style>
</head>
<body>
    <div id="left-pane">
        <h2>Video Call</h2>
        <iframe src="https://tavus.daily.co/c58a3ce52e7f" height="800" title="Iframe Example" allow="camera; microphone"></iframe>
    </div>
    <div id="right-pane">
        <h2>Live Utterances</h2>
        <div id="utterances-content">
            <p>Waiting for utterances...</p>
        </div>
    </div>

    <script>
        const utterancesDiv = document.getElementById('utterances-content');
        
        function setupEventSource() {
            console.log("Setting up EventSource...");
            const eventSource = new EventSource('http://localhost:5001/listen-utterances');
            console.log("EventSource created:", eventSource);
            console.log("Initial readyState:", eventSource.readyState);

            // Using addEventListener for 'open'
            eventSource.addEventListener('open', function(event) {
                console.log("OPEN event received. ReadyState:", eventSource.readyState);
                const waitingMsg = utterancesDiv.querySelector('p');
                if (waitingMsg) {
                    waitingMsg.textContent = "Connected. Waiting for utterances...";
                }
            });

            // Using addEventListener for 'message'
            eventSource.addEventListener('message', function(event) {
                console.log("MESSAGE event received. Data:", event.data);
                try {
                    const utterance = JSON.parse(event.data);
                    console.log("Parsed utterance:", utterance);
                    
                    const newUtterance = document.createElement('p');
                    newUtterance.textContent = utterance;
                    utterancesDiv.insertBefore(newUtterance, utterancesDiv.firstChild);
                } catch (error) {
                    console.error("Error processing message:", error);
                }
            });

            // Using addEventListener for 'error'
            eventSource.addEventListener('error', function(event) {
                console.error("ERROR event received:", event);
                if (eventSource.readyState === EventSource.CLOSED) {
                    console.log("Connection was closed. ReadyState:", eventSource.readyState);
                }
            });

            // Log any state changes
            setInterval(() => {
                console.log("Current readyState:", eventSource.readyState);
            }, 5000);

            return eventSource;
        }

        // Create the EventSource
        const eventSource = setupEventSource();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                console.log("Closing EventSource connection...");
                eventSource.close();
            }
        });
    </script>
</body>
</html>